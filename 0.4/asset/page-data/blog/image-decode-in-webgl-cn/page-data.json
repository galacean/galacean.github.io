{"componentChunkName":"component---src-templates-docs-tsx","path":"/blog/image-decode-in-webgl-cn","result":{"data":{"markdownRemark":{"html":"<blockquote>\n<p>作者：<a href=\"https://github.com/gz65555\">月木</a></p>\n</blockquote>\n<p>虽然 WebGL 支持 <a href=\"https://zh.wikipedia.org/wiki/%E7%BA%B9%E7%90%86%E5%8E%8B%E7%BC%A9\">压缩纹理</a>，上传 GPU 不存在解码耗时的问题，但日常应用中还是会用到 png/jpg/webp 等压缩过的图片格式。这些格式在 WebGL 中渲染需要转换成位图，即每个像素使用 RGB 或 RGBA 表示。这个过程称为<strong>图片解码</strong>。图片解码在渲染中是非常重要的一环，若直接使用 Image 对象上传(<a href=\"https://developer.mozilla.org/zh-CN/docs/Web/API/WebGLRenderingContext/texImage2D\">texImage2D</a>)至 GPU，往往耗时较长，阻塞主线程，比如说会导致动画播放卡顿，影响用户体验。所以，在这里我们对浏览器中的一些 WebGL 中图片解码的方案做了一些研究和测试。</p>\n<p><img src=\"https://gw.alipayobjects.com/zos/OasisHub/8524aac7-70c7-4ab1-b907-0a2522f1e301/1619169474197-0d204baf-d9de-40b7-a368-6401724aee8f.gif\" alt=\"左.gif\"></p>\n<p><img src=\"https://gw.alipayobjects.com/zos/OasisHub/122ff3ad-6774-41c1-b27e-a1142b9fcb95/1619169493323-04f264c2-56a7-4860-b7c8-9a265df78343.gif\" alt=\"右.gif\"></p>\n<blockquote>\n<p>第一幅图是同步解码，第二幅图是异步解码，可以看到明显缓解动画的卡顿</p>\n</blockquote>\n<p>本文重点测试的是 <a href=\"https://developer.mozilla.org/zh-cn/docs/Web/API/HTMLImageElement/decode\">Image.decode</a> 方法和 <a href=\"https://developer.mozilla.org/zh-CN/docs/Web/API/WindowOrWorkerGlobalScope/createImageBitmap\">createImageBitmap</a> 方法。</p>\n<h2 id=\"imagedecode\" style=\"position:relative;\"><a href=\"#imagedecode\" aria-label=\"imagedecode permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Image.decode</h2>\n<p><code>Image.decode</code> 可以异步对 <code>Image</code> 进行解码，异步的解码不会阻塞主线程动画和交互。使用方法如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> img <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Image</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nimg<span class=\"token punctuation\">.</span>src <span class=\"token operator\">=</span> <span class=\"token string\">'...'</span><span class=\"token punctuation\">;</span>\nimg<span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  document<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>img<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"createimagebitmap\" style=\"position:relative;\"><a href=\"#createimagebitmap\" aria-label=\"createimagebitmap permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>createImageBitmap</h2>\n<p><a href=\"https://developer.mozilla.org/zh-CN/docs/Web/API/ImageBitmap\">ImageBitmap</a> 是专门为 Canvas 和 WebGL 渲染使用的一种数据格式。<code>createImageBitmap</code> 会异步返回一个含 <a href=\"https://developer.mozilla.org/zh-CN/docs/Web/API/ImageBitmap\">ImageBitmap</a> 对象的 Promise。<code>createImageBitmap</code> 可以在 worker 中使用，ImageBitmap 也可以在 worker 之间传输。createImageBitmap 接受多种数据源，本文重点测试 Blob 和 HTMLImageElement，这两种对象在渲染引擎中最常使用。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 使用 image 作为源</span>\n<span class=\"token function\">createImageBitmap</span><span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">imageBitmap</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=></span><span class=\"token punctuation\">{</span>\n  gl<span class=\"token punctuation\">.</span><span class=\"token function\">texImage2D</span><span class=\"token punctuation\">(</span>gl<span class=\"token punctuation\">.</span><span class=\"token constant\">TEXTURE_2D</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> gl<span class=\"token punctuation\">.</span><span class=\"token constant\">RGBA</span><span class=\"token punctuation\">,</span> gl<span class=\"token punctuation\">.</span><span class=\"token constant\">RGBA</span><span class=\"token punctuation\">,</span> gl<span class=\"token punctuation\">.</span><span class=\"token constant\">UNSIGNED_BYTE</span><span class=\"token punctuation\">,</span> imageBitmap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// 使用 blob 作为源</span>\n<span class=\"token function\">createImageBitmap</span><span class=\"token punctuation\">(</span>blob<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">imageBitmap</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=></span><span class=\"token punctuation\">{</span>\n  gl<span class=\"token punctuation\">.</span><span class=\"token function\">texImage2D</span><span class=\"token punctuation\">(</span>gl<span class=\"token punctuation\">.</span><span class=\"token constant\">TEXTURE_2D</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> gl<span class=\"token punctuation\">.</span><span class=\"token constant\">RGBA</span><span class=\"token punctuation\">,</span> gl<span class=\"token punctuation\">.</span><span class=\"token constant\">RGBA</span><span class=\"token punctuation\">,</span> gl<span class=\"token punctuation\">.</span><span class=\"token constant\">UNSIGNED_BYTE</span><span class=\"token punctuation\">,</span> imageBitmap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<hr>\n<h2 id=\"性能测试\" style=\"position:relative;\"><a href=\"#%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95\" aria-label=\"性能测试 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>性能测试</h2>\n<p>上面介绍完了两个异步解码 API 的基本使用，接下去我用 5 种方式对 100 张<strong>不同</strong>的 1024 * 1024 图（图片由<a href=\"https://github.com/gz65555/image-decode-test/blob/main/process.js\">脚本</a>随机生成）进行解码测试，对比图片的解码时间和纹理上传时间。五种方式如下：</p>\n<ol>\n<li>使用 Image 作为源用 createImageBitmap 方法。（<a href=\"https://github.com/gz65555/image-decode-test/blob/main/image-bitmap-upload.html\">示例</a>）</li>\n<li>使用 Blob 作为源使用 createImageBitmap 。（<a href=\"https://github.com/gz65555/image-decode-test/blob/main/bitmap-blob.html\">示例</a>）</li>\n<li>开启 5 个 worker 使用 createImageBitmap 方法。（<a href=\"https://github.com/gz65555/image-decode-test/blob/main/bitmap-decode-worker.html\">示例</a>）</li>\n<li>使用 image.decode 进行解码。（<a href=\"https://github.com/gz65555/image-decode-test/blob/main/image-upload-decode.html\">示例</a>）</li>\n<li>使用 image 直接上传纹理。（<a href=\"https://github.com/gz65555/image-decode-test/blob/main/image-upload.html\">示例</a>）</li>\n</ol>\n<p>进过上面几项测试得出结果（上下浮动 100ms 左右）：</p>\n<h4 id=\"1-macos（26-ghz-i7-chrome-87-降低-6-倍性能\" style=\"position:relative;\"><a href=\"#1-macos%EF%BC%8826-ghz-i7-chrome-87-%E9%99%8D%E4%BD%8E-6-%E5%80%8D%E6%80%A7%E8%83%BD\" aria-label=\"1 macos（26 ghz i7 chrome 87 降低 6 倍性能 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. MacOS（2.6 GHz i7 chrome 87 降低 6 倍性能)</h4>\n<table>\n<thead>\n<tr>\n<th>使用方法</th>\n<th>解码时间(毫秒)</th>\n<th>纹理上传时间(毫秒)</th>\n<th>总时间</th>\n<th>备注</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>createImageBitmap(Image)</td>\n<td>2625</td>\n<td>2967</td>\n<td>5592</td>\n<td>异步解码</td>\n</tr>\n<tr>\n<td>createImageBitmap(Blob)</td>\n<td>559</td>\n<td>2180</td>\n<td>2739</td>\n<td>异步解码</td>\n</tr>\n<tr>\n<td>createImageBitmap(Blob) + worker</td>\n<td>210</td>\n<td>2000</td>\n<td>2210</td>\n<td>异步 + 多线程解码</td>\n</tr>\n<tr>\n<td>image 直接上传</td>\n<td></td>\n<td>3020</td>\n<td>3020</td>\n<td>同步解码</td>\n</tr>\n<tr>\n<td>image.decode 后上传</td>\n<td>210</td>\n<td>4978</td>\n<td>5188</td>\n<td>异步解码</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"2-android-u4（mi-10-pro-u4-3210172）\" style=\"position:relative;\"><a href=\"#2-android-u4%EF%BC%88mi-10-pro-u4-3210172%EF%BC%89\" aria-label=\"2 android u4（mi 10 pro u4 3210172） permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Android U4（Mi 10 Pro U4 3.21.0.172）</h4>\n<table>\n<thead>\n<tr>\n<th>使用方法</th>\n<th>解码时间(毫秒)</th>\n<th>纹理上传时间(毫秒)</th>\n<th>总时间</th>\n<th>备注</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>createImageBitmap(Image)</td>\n<td>1540</td>\n<td>878</td>\n<td>2418</td>\n<td>异步解码</td>\n</tr>\n<tr>\n<td>createImageBitmap(Blob)</td>\n<td>1096</td>\n<td>129</td>\n<td>1225</td>\n<td>异步解码</td>\n</tr>\n<tr>\n<td>createImageBitmap(Blob) + worker</td>\n<td>715</td>\n<td>142</td>\n<td>857</td>\n<td>异步 + 多线程解码</td>\n</tr>\n<tr>\n<td>image 直接上传</td>\n<td></td>\n<td>905</td>\n<td>905</td>\n<td>同步解码</td>\n</tr>\n<tr>\n<td><del>image.decode 后上传</del></td>\n<td></td>\n<td></td>\n<td>decode 报错，The source image cannot be decoded.</td>\n<td>异步解码</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"3-android-chrome（mi-10-pro-android-chrome-87）\" style=\"position:relative;\"><a href=\"#3-android-chrome%EF%BC%88mi-10-pro-android-chrome-87%EF%BC%89\" aria-label=\"3 android chrome（mi 10 pro android chrome 87） permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Android Chrome（Mi 10 Pro Android Chrome 87）</h4>\n<table>\n<thead>\n<tr>\n<th>使用方法</th>\n<th>解码时间(毫秒)</th>\n<th>纹理上传时间(毫秒)</th>\n<th>总时间</th>\n<th>备注</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>createImageBitmap(Image)</td>\n<td>522</td>\n<td>504</td>\n<td>1026</td>\n<td>异步解码</td>\n</tr>\n<tr>\n<td>createImageBitmap(Blob)</td>\n<td>310</td>\n<td>135</td>\n<td>445</td>\n<td>异步解码</td>\n</tr>\n<tr>\n<td>createImageBitmap(Blob) + worker</td>\n<td>249</td>\n<td>145</td>\n<td>394</td>\n<td>异步 + 多线程解码</td>\n</tr>\n<tr>\n<td>image 直接上传</td>\n<td></td>\n<td>510</td>\n<td>510</td>\n<td>同步解码</td>\n</tr>\n<tr>\n<td><del>image.decode 后上传</del></td>\n<td></td>\n<td></td>\n<td>decode 报错，The source image cannot be decoded.</td>\n<td>异步解码</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"4-ios-safari（iphone7-ios-142）\" style=\"position:relative;\"><a href=\"#4-ios-safari%EF%BC%88iphone7-ios-142%EF%BC%89\" aria-label=\"4 ios safari（iphone7 ios 142） permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. iOS safari（iPhone7 iOS 14.2）</h4>\n<table>\n<thead>\n<tr>\n<th>使用方法</th>\n<th>解码时间(毫秒)</th>\n<th>纹理上传时间(毫秒)</th>\n<th>总时间</th>\n<th>备注</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><del>createImageBitmap(Image)</del></td>\n<td></td>\n<td></td>\n<td>不支持</td>\n<td></td>\n</tr>\n<tr>\n<td><del>createImageBitmap(Blob)</del></td>\n<td></td>\n<td></td>\n<td>不支持</td>\n<td></td>\n</tr>\n<tr>\n<td><del>createImageBitmap(Blob) + worker</del></td>\n<td></td>\n<td></td>\n<td>不支持</td>\n<td></td>\n</tr>\n<tr>\n<td>image 直接上传</td>\n<td></td>\n<td>1076</td>\n<td>1076</td>\n<td>同步解码</td>\n</tr>\n<tr>\n<td>image.decode 后上传</td>\n<td>2076</td>\n<td>300</td>\n<td>2376</td>\n<td>异步解码</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"结论\" style=\"position:relative;\"><a href=\"#%E7%BB%93%E8%AE%BA\" aria-label=\"结论 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>结论</h2>\n<p>通过以上测试，可以得出以下结论：</p>\n<ol>\n<li>\n<p>Android 和 Mac Chrome 推荐用 <code>createImageBitmap</code>，数据源务必使用 <code>Blob</code>，解码可以提升 10% 左右的性能：</p>\n<ol>\n<li>若数据源使用 <code>Blob</code>，无解码时间；若数据源使用 <code>Image</code>，有两次时间消耗，首先创建 bitmap 耗时很长，其次在 performance 里查看仍有解码时间（预期不该有解码时间，这是 Chrome 的 Bug，已经给 chromium 提了一个 <a href=\"https://bugs.chromium.org/p/chromium/issues/detail?id=1164969\">issue</a>，chrome 官方已经确认问题存在）。</li>\n<li>在 worker 中调用 <code>createImageBitmap</code> 可以利用多线程能力，能进一步提升 15% 左右的性能。因为 worker 线程还不算特别稳定，是否开启 worker 解码交由用户配置决定，用户根据当前 cpu 负载及所需解码数量和业务场景去决定是否使用 worker 解码。</li>\n</ol>\n</li>\n<li>\n<p>iOS  不要用任何异步解码方案：</p>\n<ol>\n<li>不支持 <code>createImageBitmap</code>；</li>\n<li>使用 <code>Image.decode</code> 的总时间是同步解码的两倍；</li>\n</ol>\n</li>\n</ol>\n<p>根据上面测试的结果以及推导的结论，在 WebGL 中采取的图片请求最佳解码方案是：</p>\n<p><img src=\"https://gw.alipayobjects.com/zos/OasisHub/983bea3d-909e-4acc-b81e-f5808f60f73f/3ea78572041822b115811b2ed58d5c9a.svg\"></p>\n<p>以上方案即将应用到 oasis-engine 中，欢迎大家在 <a href=\"https://github.com/oasis-engine/engine/pull/249\">PR</a> 中讨论。</p>","htmlAst":{"type":"root","children":[{"type":"element","tagName":"blockquote","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"作者："},{"type":"element","tagName":"a","properties":{"href":"https://github.com/gz65555"},"children":[{"type":"text","value":"月木"}]}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"虽然 WebGL 支持 "},{"type":"element","tagName":"a","properties":{"href":"https://zh.wikipedia.org/wiki/%E7%BA%B9%E7%90%86%E5%8E%8B%E7%BC%A9"},"children":[{"type":"text","value":"压缩纹理"}]},{"type":"text","value":"，上传 GPU 不存在解码耗时的问题，但日常应用中还是会用到 png/jpg/webp 等压缩过的图片格式。这些格式在 WebGL 中渲染需要转换成位图，即每个像素使用 RGB 或 RGBA 表示。这个过程称为"},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"图片解码"}]},{"type":"text","value":"。图片解码在渲染中是非常重要的一环，若直接使用 Image 对象上传("},{"type":"element","tagName":"a","properties":{"href":"https://developer.mozilla.org/zh-CN/docs/Web/API/WebGLRenderingContext/texImage2D"},"children":[{"type":"text","value":"texImage2D"}]},{"type":"text","value":")至 GPU，往往耗时较长，阻塞主线程，比如说会导致动画播放卡顿，影响用户体验。所以，在这里我们对浏览器中的一些 WebGL 中图片解码的方案做了一些研究和测试。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"img","properties":{"src":"https://gw.alipayobjects.com/zos/OasisHub/8524aac7-70c7-4ab1-b907-0a2522f1e301/1619169474197-0d204baf-d9de-40b7-a368-6401724aee8f.gif","alt":"左.gif"},"children":[]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"img","properties":{"src":"https://gw.alipayobjects.com/zos/OasisHub/122ff3ad-6774-41c1-b27e-a1142b9fcb95/1619169493323-04f264c2-56a7-4860-b7c8-9a265df78343.gif","alt":"右.gif"},"children":[]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"blockquote","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"第一幅图是同步解码，第二幅图是异步解码，可以看到明显缓解动画的卡顿"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"本文重点测试的是 "},{"type":"element","tagName":"a","properties":{"href":"https://developer.mozilla.org/zh-cn/docs/Web/API/HTMLImageElement/decode"},"children":[{"type":"text","value":"Image.decode"}]},{"type":"text","value":" 方法和 "},{"type":"element","tagName":"a","properties":{"href":"https://developer.mozilla.org/zh-CN/docs/Web/API/WindowOrWorkerGlobalScope/createImageBitmap"},"children":[{"type":"text","value":"createImageBitmap"}]},{"type":"text","value":" 方法。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{"id":"imagedecode","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#imagedecode","ariaLabel":"imagedecode permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"Image.decode"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"Image.decode"}]},{"type":"text","value":" 可以异步对 "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"Image"}]},{"type":"text","value":" 进行解码，异步的解码不会阻塞主线程动画和交互。使用方法如下："}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"javascript"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-javascript"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-javascript"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"const"}]},{"type":"text","value":" img "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"new"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","class-name"]},"children":[{"type":"text","value":"Image"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":"\nimg"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"text","value":"src "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'...'"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":"\nimg"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"decode"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"then"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"function"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n  document"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"text","value":"body"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"appendChild"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"text","value":"img"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{"id":"createimagebitmap","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#createimagebitmap","ariaLabel":"createimagebitmap permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"createImageBitmap"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"a","properties":{"href":"https://developer.mozilla.org/zh-CN/docs/Web/API/ImageBitmap"},"children":[{"type":"text","value":"ImageBitmap"}]},{"type":"text","value":" 是专门为 Canvas 和 WebGL 渲染使用的一种数据格式。"},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"createImageBitmap"}]},{"type":"text","value":" 会异步返回一个含 "},{"type":"element","tagName":"a","properties":{"href":"https://developer.mozilla.org/zh-CN/docs/Web/API/ImageBitmap"},"children":[{"type":"text","value":"ImageBitmap"}]},{"type":"text","value":" 对象的 Promise。"},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"createImageBitmap"}]},{"type":"text","value":" 可以在 worker 中使用，ImageBitmap 也可以在 worker 之间传输。createImageBitmap 接受多种数据源，本文重点测试 Blob 和 HTMLImageElement，这两种对象在渲染引擎中最常使用。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"javascript"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-javascript"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-javascript"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"// 使用 image 作为源"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"createImageBitmap"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"text","value":"image"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"then"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","parameter"]},"children":[{"type":"text","value":"imageBitmap"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"=>"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n  gl"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"texImage2D"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"text","value":"gl"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["token","constant"]},"children":[{"type":"text","value":"TEXTURE_2D"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"0"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" gl"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["token","constant"]},"children":[{"type":"text","value":"RGBA"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" gl"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["token","constant"]},"children":[{"type":"text","value":"RGBA"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" gl"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["token","constant"]},"children":[{"type":"text","value":"UNSIGNED_BYTE"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" imageBitmap"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"// 使用 blob 作为源"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"createImageBitmap"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"text","value":"blob"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"then"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","parameter"]},"children":[{"type":"text","value":"imageBitmap"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"=>"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n  gl"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"texImage2D"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"text","value":"gl"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["token","constant"]},"children":[{"type":"text","value":"TEXTURE_2D"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"0"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" gl"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["token","constant"]},"children":[{"type":"text","value":"RGBA"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" gl"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["token","constant"]},"children":[{"type":"text","value":"RGBA"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" gl"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["token","constant"]},"children":[{"type":"text","value":"UNSIGNED_BYTE"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" imageBitmap"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"hr","properties":{},"children":[]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{"id":"性能测试","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95","ariaLabel":"性能测试 permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"性能测试"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"上面介绍完了两个异步解码 API 的基本使用，接下去我用 5 种方式对 100 张"},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"不同"}]},{"type":"text","value":"的 1024 * 1024 图（图片由"},{"type":"element","tagName":"a","properties":{"href":"https://github.com/gz65555/image-decode-test/blob/main/process.js"},"children":[{"type":"text","value":"脚本"}]},{"type":"text","value":"随机生成）进行解码测试，对比图片的解码时间和纹理上传时间。五种方式如下："}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"使用 Image 作为源用 createImageBitmap 方法。（"},{"type":"element","tagName":"a","properties":{"href":"https://github.com/gz65555/image-decode-test/blob/main/image-bitmap-upload.html"},"children":[{"type":"text","value":"示例"}]},{"type":"text","value":"）"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"使用 Blob 作为源使用 createImageBitmap 。（"},{"type":"element","tagName":"a","properties":{"href":"https://github.com/gz65555/image-decode-test/blob/main/bitmap-blob.html"},"children":[{"type":"text","value":"示例"}]},{"type":"text","value":"）"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"开启 5 个 worker 使用 createImageBitmap 方法。（"},{"type":"element","tagName":"a","properties":{"href":"https://github.com/gz65555/image-decode-test/blob/main/bitmap-decode-worker.html"},"children":[{"type":"text","value":"示例"}]},{"type":"text","value":"）"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"使用 image.decode 进行解码。（"},{"type":"element","tagName":"a","properties":{"href":"https://github.com/gz65555/image-decode-test/blob/main/image-upload-decode.html"},"children":[{"type":"text","value":"示例"}]},{"type":"text","value":"）"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"使用 image 直接上传纹理。（"},{"type":"element","tagName":"a","properties":{"href":"https://github.com/gz65555/image-decode-test/blob/main/image-upload.html"},"children":[{"type":"text","value":"示例"}]},{"type":"text","value":"）"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"进过上面几项测试得出结果（上下浮动 100ms 左右）："}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h4","properties":{"id":"1-macos（26-ghz-i7-chrome-87-降低-6-倍性能","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#1-macos%EF%BC%8826-ghz-i7-chrome-87-%E9%99%8D%E4%BD%8E-6-%E5%80%8D%E6%80%A7%E8%83%BD","ariaLabel":"1 macos（26 ghz i7 chrome 87 降低 6 倍性能 permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"1. MacOS（2.6 GHz i7 chrome 87 降低 6 倍性能)"}]},{"type":"text","value":"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"},{"type":"element","tagName":"table","properties":{},"children":[{"type":"element","tagName":"thead","properties":{},"children":[{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"使用方法"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"解码时间(毫秒)"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"纹理上传时间(毫秒)"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"总时间"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"备注"}]}]}]},{"type":"element","tagName":"tbody","properties":{},"children":[{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"createImageBitmap(Image)"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"2625"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"2967"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"5592"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"异步解码"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"createImageBitmap(Blob)"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"559"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"2180"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"2739"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"异步解码"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"createImageBitmap(Blob) + worker"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"210"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"2000"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"2210"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"异步 + 多线程解码"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"image 直接上传"}]},{"type":"element","tagName":"td","properties":{},"children":[]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"3020"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"3020"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"同步解码"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"image.decode 后上传"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"210"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"4978"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"5188"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"异步解码"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h4","properties":{"id":"2-android-u4（mi-10-pro-u4-3210172）","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#2-android-u4%EF%BC%88mi-10-pro-u4-3210172%EF%BC%89","ariaLabel":"2 android u4（mi 10 pro u4 3210172） permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"2. Android U4（Mi 10 Pro U4 3.21.0.172）"}]},{"type":"text","value":"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"},{"type":"element","tagName":"table","properties":{},"children":[{"type":"element","tagName":"thead","properties":{},"children":[{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"使用方法"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"解码时间(毫秒)"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"纹理上传时间(毫秒)"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"总时间"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"备注"}]}]}]},{"type":"element","tagName":"tbody","properties":{},"children":[{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"createImageBitmap(Image)"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"1540"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"878"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"2418"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"异步解码"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"createImageBitmap(Blob)"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"1096"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"129"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"1225"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"异步解码"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"createImageBitmap(Blob) + worker"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"715"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"142"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"857"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"异步 + 多线程解码"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"image 直接上传"}]},{"type":"element","tagName":"td","properties":{},"children":[]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"905"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"905"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"同步解码"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"element","tagName":"del","properties":{},"children":[{"type":"text","value":"image.decode 后上传"}]}]},{"type":"element","tagName":"td","properties":{},"children":[]},{"type":"element","tagName":"td","properties":{},"children":[]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"decode 报错，The source image cannot be decoded."}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"异步解码"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h4","properties":{"id":"3-android-chrome（mi-10-pro-android-chrome-87）","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#3-android-chrome%EF%BC%88mi-10-pro-android-chrome-87%EF%BC%89","ariaLabel":"3 android chrome（mi 10 pro android chrome 87） permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"3. Android Chrome（Mi 10 Pro Android Chrome 87）"}]},{"type":"text","value":"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"},{"type":"element","tagName":"table","properties":{},"children":[{"type":"element","tagName":"thead","properties":{},"children":[{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"使用方法"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"解码时间(毫秒)"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"纹理上传时间(毫秒)"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"总时间"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"备注"}]}]}]},{"type":"element","tagName":"tbody","properties":{},"children":[{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"createImageBitmap(Image)"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"522"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"504"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"1026"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"异步解码"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"createImageBitmap(Blob)"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"310"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"135"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"445"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"异步解码"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"createImageBitmap(Blob) + worker"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"249"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"145"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"394"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"异步 + 多线程解码"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"image 直接上传"}]},{"type":"element","tagName":"td","properties":{},"children":[]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"510"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"510"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"同步解码"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"element","tagName":"del","properties":{},"children":[{"type":"text","value":"image.decode 后上传"}]}]},{"type":"element","tagName":"td","properties":{},"children":[]},{"type":"element","tagName":"td","properties":{},"children":[]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"decode 报错，The source image cannot be decoded."}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"异步解码"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h4","properties":{"id":"4-ios-safari（iphone7-ios-142）","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#4-ios-safari%EF%BC%88iphone7-ios-142%EF%BC%89","ariaLabel":"4 ios safari（iphone7 ios 142） permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"4. iOS safari（iPhone7 iOS 14.2）"}]},{"type":"text","value":"\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"},{"type":"element","tagName":"table","properties":{},"children":[{"type":"element","tagName":"thead","properties":{},"children":[{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"使用方法"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"解码时间(毫秒)"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"纹理上传时间(毫秒)"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"总时间"}]},{"type":"element","tagName":"th","properties":{},"children":[{"type":"text","value":"备注"}]}]}]},{"type":"element","tagName":"tbody","properties":{},"children":[{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"element","tagName":"del","properties":{},"children":[{"type":"text","value":"createImageBitmap(Image)"}]}]},{"type":"element","tagName":"td","properties":{},"children":[]},{"type":"element","tagName":"td","properties":{},"children":[]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"不支持"}]},{"type":"element","tagName":"td","properties":{},"children":[]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"element","tagName":"del","properties":{},"children":[{"type":"text","value":"createImageBitmap(Blob)"}]}]},{"type":"element","tagName":"td","properties":{},"children":[]},{"type":"element","tagName":"td","properties":{},"children":[]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"不支持"}]},{"type":"element","tagName":"td","properties":{},"children":[]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"element","tagName":"del","properties":{},"children":[{"type":"text","value":"createImageBitmap(Blob) + worker"}]}]},{"type":"element","tagName":"td","properties":{},"children":[]},{"type":"element","tagName":"td","properties":{},"children":[]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"不支持"}]},{"type":"element","tagName":"td","properties":{},"children":[]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"image 直接上传"}]},{"type":"element","tagName":"td","properties":{},"children":[]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"1076"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"1076"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"同步解码"}]}]},{"type":"element","tagName":"tr","properties":{},"children":[{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"image.decode 后上传"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"2076"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"300"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"2376"}]},{"type":"element","tagName":"td","properties":{},"children":[{"type":"text","value":"异步解码"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{"id":"结论","style":"position:relative;"},"children":[{"type":"element","tagName":"a","properties":{"href":"#%E7%BB%93%E8%AE%BA","ariaLabel":"结论 permalink","className":["anchor","before"]},"children":[{"type":"element","tagName":"svg","properties":{"ariaHidden":"true","focusable":"false","height":"16","version":"1.1","viewBox":"0 0 16 16","width":"16"},"children":[{"type":"element","tagName":"path","properties":{"fillRule":"evenodd","d":"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"},"children":[]}]}]},{"type":"text","value":"结论"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"通过以上测试，可以得出以下结论："}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Android 和 Mac Chrome 推荐用 "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"createImageBitmap"}]},{"type":"text","value":"，数据源务必使用 "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"Blob"}]},{"type":"text","value":"，解码可以提升 10% 左右的性能："}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"若数据源使用 "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"Blob"}]},{"type":"text","value":"，无解码时间；若数据源使用 "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"Image"}]},{"type":"text","value":"，有两次时间消耗，首先创建 bitmap 耗时很长，其次在 performance 里查看仍有解码时间（预期不该有解码时间，这是 Chrome 的 Bug，已经给 chromium 提了一个 "},{"type":"element","tagName":"a","properties":{"href":"https://bugs.chromium.org/p/chromium/issues/detail?id=1164969"},"children":[{"type":"text","value":"issue"}]},{"type":"text","value":"，chrome 官方已经确认问题存在）。"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"在 worker 中调用 "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"createImageBitmap"}]},{"type":"text","value":" 可以利用多线程能力，能进一步提升 15% 左右的性能。因为 worker 线程还不算特别稳定，是否开启 worker 解码交由用户配置决定，用户根据当前 cpu 负载及所需解码数量和业务场景去决定是否使用 worker 解码。"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"iOS  不要用任何异步解码方案："}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"不支持 "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"createImageBitmap"}]},{"type":"text","value":"；"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"使用 "},{"type":"element","tagName":"code","properties":{},"children":[{"type":"text","value":"Image.decode"}]},{"type":"text","value":" 的总时间是同步解码的两倍；"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"根据上面测试的结果以及推导的结论，在 WebGL 中采取的图片请求最佳解码方案是："}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"img","properties":{"src":"https://gw.alipayobjects.com/zos/OasisHub/983bea3d-909e-4acc-b81e-f5808f60f73f/3ea78572041822b115811b2ed58d5c9a.svg"},"children":[]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"以上方案即将应用到 oasis-engine 中，欢迎大家在 "},{"type":"element","tagName":"a","properties":{"href":"https://github.com/oasis-engine/engine/pull/249"},"children":[{"type":"text","value":"PR"}]},{"type":"text","value":" 中讨论。"}]}],"data":{"quirksMode":false}},"tableOfContents":"<ul>\n<li><a href=\"/blog/image-decode-in-webgl-cn/#imagedecode\">Image.decode</a></li>\n<li><a href=\"/blog/image-decode-in-webgl-cn/#createimagebitmap\">createImageBitmap</a></li>\n<li>\n<p><a href=\"/blog/image-decode-in-webgl-cn/#%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95\">性能测试</a></p>\n<ul>\n<li>\n<ul>\n<li><a href=\"/blog/image-decode-in-webgl-cn/#1-macos%EF%BC%8826-ghz-i7-chrome-87-%E9%99%8D%E4%BD%8E-6-%E5%80%8D%E6%80%A7%E8%83%BD\">1. MacOS（2.6 GHz i7 chrome 87 降低 6 倍性能)</a></li>\n<li><a href=\"/blog/image-decode-in-webgl-cn/#2-android-u4%EF%BC%88mi-10-pro-u4-3210172%EF%BC%89\">2. Android U4（Mi 10 Pro U4 3.21.0.172）</a></li>\n<li><a href=\"/blog/image-decode-in-webgl-cn/#3-android-chrome%EF%BC%88mi-10-pro-android-chrome-87%EF%BC%89\">3. Android Chrome（Mi 10 Pro Android Chrome 87）</a></li>\n<li><a href=\"/blog/image-decode-in-webgl-cn/#4-ios-safari%EF%BC%88iphone7-ios-142%EF%BC%89\">4. iOS safari（iPhone7 iOS 14.2）</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li><a href=\"/blog/image-decode-in-webgl-cn/#%E7%BB%93%E8%AE%BA\">结论</a></li>\n</ul>","frontmatter":{"title":"WebGL 中的图片解码优化","order":null,"type":"Blog"},"fields":{"path":"/blog/image-decode-in-webgl.zh-CN.md","slug":"/blog/image-decode-in-webgl-cn","modifiedTime":1624109082216,"source":"https://github.com/oasis-engine/oasis-engine.github.io/blob/0.4/blog/image-decode-in-webgl.zh-CN.md"}},"allMarkdownRemark":{"edges":[{"node":{"frontmatter":{"title":"Oasis Engine v0.3 发布","order":null,"type":"Blog","time":"2021-04-07T00:00:00.000Z"},"fields":{"slug":"/blog/v0.3-release-cn","path":"/blog/v0.3-release.zh-CN.md"}}},{"node":{"frontmatter":{"title":"WebGL 中的图片解码优化","order":null,"type":"Blog","time":"2021-04-23T00:00:00.000Z"},"fields":{"slug":"/blog/image-decode-in-webgl-cn","path":"/blog/image-decode-in-webgl.zh-CN.md"}}},{"node":{"frontmatter":{"title":"Oasis 引擎渲染管线的优化之路","order":null,"type":"Blog","time":"2021-05-12T00:00:00.000Z"},"fields":{"slug":"/blog/rendering-pipeline-cn","path":"/blog/rendering-pipeline.zh-CN.md"}}},{"node":{"frontmatter":{"title":"Oasis Engine v0.4 发布","order":null,"type":"Blog","time":"2021-06-17T00:00:00.000Z"},"fields":{"slug":"/blog/v0.4-release-cn","path":"/blog/v0.4-release.zh-CN.md"}}}]}},"pageContext":{"slug":"/blog/image-decode-in-webgl-cn","type":"/blog/","locale":"/-cn/"}},"staticQueryHashes":[]}